---
layout: main
title: Documentation
---

<h1>Documentation</h1>
<div class="description">
  <p>archTK documentation is composed by <a href="/tutorials.html" target="_blank" title="video Tutorials">archTk video tutorials</a>, <a href="/usecases.html" target="_blank" title="use cases">archTK usecases</a>, <a href="#pyNS_architecture">pyNS architecture</a>, <a href="#pyNS_how-to">pyNS how-to guidelines</a>, <a href="#pyNS_examples">pyNS development examples</a>, <a href="#regex">regex building for xml equations</a> and <a href="#archNE_documentation">archNE documentation.</a></p>
</div>
<div class="button_container">
	<a class="button" href="/tutorials.html"target="_blank" onclick="this.blur();"><span>Video tutorials</span></a> 
	<a class="button" href="/usecases.html"target="_blank" onclick="this.blur();"><span>Use cases</span></a> 
</div>
  
<h2><a name="pyNS_architecture">pyNS architecture</a></h2>
<h3>Background</h3>

<div class="description_2">
<p>The python Network Solver (pyNS), is a software developed in Python with numpy package, needed for scientific computing with Python, with the aim to simulate hemodynamic behavior in vascular networks. pyNS is developed in the Department of Bioengineering, at Mario Negri Institute (MNI) with support from the EC FP7/2007-2013: ARCH, Project n. 224390.</p>
<p>In the contest of the Arch Project, the aim of the application is to simulate hemodynamic changes induced by AVF surgery and long-term vascular and cardiac adaptation and to predict AVF function for improvement of surgical planning and AVF management. Verification of model prediction of AVF maturation, patency, onset of steal syndrome and cardiac overload will be performed on the basis of prospective observational studies in HD patients.</p>
</div>

<h3>Product Perspective</h3>
<div class="description_2">
<div class="attachment_container">
	<a href="media/pyNS_overall.png" rel="lightbox" title="Major components of the overall system and subsystem interconnections."><img class="screenshot" width="150" src="media/pyNS_overall.png" alt="pyNS Architecture"/></a>
</div>
<p>pyNS has been designed with an object-oriented approach, which allows to abstracts the concept of element from the numerical solver itself.</p>
<p>All the components developed are open-source and pyNS can simply be installed and run on all platforms. It only needs <a href="http://www.python.org/download/" target="_blank" title="Python">Python(2.x)</a>, <a href="http://www.scipy.org/Download" target="_blank" title="Numpy package">Numpy package</a> and <a href="http://matplotlib.sourceforge.net/" target="_blank" title="Matplotlib library">Matplotlib library</a>. Matplotlib is a python 2D plotting library, which produces publication quality figures in a variety of hardcopy formats and interactive environments across platforms. </p>
<p>pyNS currently supports <a href="#elements">elements</a> with constant properties and with linear or nonlinear expressions. <a href="#evaluator">Evaluator class</a>, using <a href="#regex">regular expressions</a>, computes values from expressions setting them into elements.</p>
<p>The <a href="#input">input data</a> for the solver will be an XML file modeling the <a href="#vascular_network">vascular network</a> and an XML file with <a href="#parameters">simulation parameters</a> and <a href="#boundary_conditions">boundary conditions.</a> <a href="#patient_data">Patient specific data</a> can be easily imported using .csv files. <a href="#model_adaptor">Model Adaptor class</a> takes as input <a href="#patient_specific">patient specific information</a> (.csv) and creates specific vascular network model from generic one and specific input provided. <a href="#mesh_generation">The mesh generation process</a> creates elements from vascular network depending of maximum length parameter or maximum radius variation. User can decide which strategy to use.</p>
<p>pyNS will provide <a href="#numerical_solver">methods for numerical integration</a> and <a href="#non_linear_convergence">non linear convergence strategies.</a></p>
<p><a href="#post_processing">Post-processing</a> features allow to visualize hemodynamic information (flow, pressure, wall shear stress...) for each element of the network. Information could be in a numeric and/or graphic (.png format) way.</p>
</div>

<h3><a name="input">Input files</a></h3>
<div class="description_2">
<p>The input data for the solver is an XML file modeling the <a href="#vascular_network">vascular network</a> and an XML file with <a href="#parameters">simulation parameters</a> and <a href="#boundary_conditions">boundary conditions.</a></p>
</div>

<h4><a name="vascular_network">The vascular network</a></h4>
<div class="description_2">
<div class="attachment_container">
<img class="left_snippet" src="media/vascular_network.png" alt="Vascular network graph"/>
</div>
<p>The XML schema of the vascular network has been created by using named types. We chose to use <em>element</em> to express information in a structured form (if an element id directly derived from an other or to take into account the possibility of extending an element content to carry more information); otherwise, to provide additional information about an element, we use one or more <em>attributes</em>. We described the Vascular Network as a graph, composed by case, nodes, edges and superedges. These elements allow defining the network topology. The first element declared (root element) is called Network Graph. Case, nodes, edges and superedges are the leaf elements; each of this is identified with a unique ID. The parameters involved in the model are given with information about unit, accuracy and source of measurement.</p>
<p>Case element provides some general information about the dataset (subject Id and protocol visit).</p>
<p>Superedges element, identified by an integer <em>id</em> and a <em>name</em>, represents a group of edges or a group of other superedges. For example, superedge <em>arm</em> can be composed by <em>brachial artery</em>, <em>radial artery</em>... superedges. Each of them is a group of edges. Superedge can be very useful when user has to assign the same parameter (or boundary condition) to many edges of the network.</p>
</div>
<div class="description_2">
<p>
<div class="attachment_container">
<img class="left_snippet" src="media/nodes.png" alt="Edge elements"/>
</div>
<div class="attachment_container">
<img class="snippet" src="media/edges.png" alt="Edge elements"/>
</div>
Each node of the vascular network is identified by an unique <em>id</em> and can be classified with a <em>type</em> attribute and with a <em>name</em>. User can specify some properties related to each node, depending of its classification. For example, if a node is classified as <em>anastomosis</em>, properties are related to resistance expressions to model the pressure drop over this element. A node can be classified as <em>anastomosis</em>, <em>bifurcation</em>, <em>inflow</em>, <em>outflow</em> or <em>downstream network</em>.<br/>
Each edge of the vascular network is identified by an unique <em>id</em>, a <em>couple of nodes</em>, a <em>name</em> and a <em>side</em> attributes which represents if edge is belonging to arterial or venous side. User can decide to specify the type of the elements generated from this edge during the <a href="#mesh_generation">mesh generation</a> process. Each edge is composed by geometry, properties and features elements. Geometry is used for specifying characteristics such as the <em>length</em> of the edge or for providing its xyz <em>spatial coordinates</em>. An edge can have one or more properties related to its radius, distensibility, wall thickness, young's modulus, specific resistance and specific compliance. If specific information are available each property can be expressed as an array of values in several locations; each value is identified by a curvilinear abscissa <em>s</em>, which can assume values from 0 to 1. <br />
It is possible to have physiological or pathological <em>features</em> (e.g., kink, stenosis, other...). Each of these conditions is identified by a curvilinear abscissa <em>s</em> and by a parameter of interest (e.g., radius and curvature for kink, radius and length for stenosis).
</p>
</div>

<h4><a name="boundary_conditions">Boundary Conditions</a></h4>
<div class="description_2">
<div class="attachment_container">
<img class="snippet" src="media/boundary_conditions.png" alt="Boundary conditions graph"/>
</div>
<p>The boundary conditions model is described as a graph, composed by different types of boundary conditions. Each boundary condition is identified by an integer <em>id</em>, a <em>type</em> and a <em>name</em>.  Each type of boundary condition is specified with its own characteristically parameters and entities associated to it. Each entity represents a group of meshes with the same type of boundary condition and is identified with a unique <em>id</em> which is related to <a href="#vascular_network">vascular network superedge's name</a> and, if needed, also with a <em>node id</em> related to <a href="#vascular_network">vascular network nodes.</a><br />
Characteristically parameters can be related to prescribed external pressures (e.g. element's transmural pressures), inflow's parameters or outflow prescribed pressures. Transmural pressure can be expressed with scalar value or in an array form. If expressed in array form, transmural pressure is time-related; so each pressure is associated with its specific time value.</p>
</div>

<h4><a name="parameters">Simulation parameters</a> and <a name="patient_data">patient data</a></h4>
<div class="description_2">
<div class="attachment_container">
<img class="medium_snippet" src="media/specific_dataset.png" alt="Patient data and parameters"/>
</div>
<p>Simulation parameters and patient data provide additional information for patient-specific <a href="#simulation">simulation.</a> </p>
<p>Simulation parameters graph is composed by a list of variables and each of them is expressed with a scalar value. By default, <em>blood density</em> (1050 kg/m<small><sup>3</small></sup>), <em>poisson ratio</em> (0.5), <em>timestep</em> (0.001 s) and <em>total number of simulation cycles</em> (10) are defined.</p>
<p>Patient data graph contains a sequence of patient personal data. Each element can be expressed by a scalar value or with an <a href="#regex">expression</a> which will be <a href="#evaluator">evaluated</a> by pyNS. User can provide patient-specific information about date of birth, date of surgery, age, gender, arm (left or right), fistula type, height (cm) and weight (kg), systolic and diastolic pressures (mmHg), mean value of cardiac output (mL/min), cardiac period (s), information about brachial, radial and ulnar mean flows (mL/min) from US measurements, blood analysis data (plasma protein concentration (cp, g/dL) and hematocrit (ht, %)), blood viscosity (Pa*s) and information about pathological problems such as diabetes (yes/no) and hypertension (yes/no).</p>
</div>

<h3><a name="generic_network">From a generic network template</a> to a <a name="patient_specific">patient-specific network</a></h3>
<div class="description_2">
<div class="attachment_container">
	<a href="media/csv.png" rel="lightbox" title="Example of csv file for patient specific customization"><img class="small_left_screenshot" width="150" src="media/csv.png" alt="Example of csv file for patient specific customization"/></a>
</div>
<div class="attachment_container">
	<a href="media/pat_spec.png" rel="lightbox" title="Patient specific customization workflow"><img class="screenshot" width="150" src="media/pat_spec.png" alt="Patient specific customization workflow"/></a>
</div>
<p>pyNS allows to generate a patient-specific network from some default generic templates, giving user the possibility to specify only some basic patient information. Vascular network geometry and properties, boundary conditions and simulation parameters are computed according to <a href="#regex">generic rules defined as expressions</a> in generic templates xml files.</p>
<p>This process can be executed either by <a href="#">archNE customization</a> or pyNS. To run customization from pyNS user has to pass a .csv file with a list of parameters and their values to <a name="model_adaptor">ModelAdaptor class</a>.</p>
<p>The primary functional responsibility of this class is to calculate parameters from <a href="#regex">expressions</a> (using <a href="#evaluator">evaluator class</a>) and to write the new <a href="#vascular_network">vascular network xml file.</a></p>
<p>A short how-to for building a patient-specific .csv file can be found in the <a href="#csv_file">pyNS how-to section</a>.</p>
</div>

<h3><a name="evaluator">Evaluator class</a></h3>
<div class="description_2">
<p>This class evaluates xml equations using <a href="#regex">regular expressions.</a></p>
<p>Evaluator class is structured for evaluating equations related to both edges of the vascular network graph and mesh elements. Moreover, an effective caching strategy was developed to save overall computational time.</p>
<p>A short how-to for building a xml equations using regular expressions can be found in the <a href="#regex">regular expression for xml equations section</a>.</p>

</div>

<h3><a name="elements">Elements class</a></h3>
<div class="description_2">
<p>Elements class represents a general element, each specific element must be referred to it.</p>
<p>Elements class provides methods for building its zero order matrix, first order matrix and second order matrix; this is a general strategy adopted for all kind of elements.</p>
<p>A short how-to for implementing a new element into pyNS can be found in the <a href="#new_elements">pyNS example section</a>.</p>
</div>

<h4>Wave propagation element</h4>
<div class="description_2">
<div class="attachment_container">
	<a href="media/wp_el.png" rel="lightbox" title="Wave propagation element"><img class="snippet" width="150" src="media/wp_el.png" alt="Wave propagation element"/></a>
</div>
<p>This element has been implemented with a 0D pulse wave propagation model as illustrated in <em>Huberts W. et al., A pulse wave propagation model to support decision-making in vascular access planning in the clinic, Med Eng and Physics, submitted.</em>. The relations between pressure and flow for each vascular segment are derived from conservation of mass and momentum by assuming fully-developed incompressible Newtonian flow in a straight vessel. In the momentum equation the convection term, the axial diffusion term and the effect of body forces are neglected. The lumped parameter model obtained consists of a resistor per unit length <em>R</em> (representing the resistance to flow through the vessel) and an inductor per unit length <em>L</em> (representing the inertia of the blood) in series. Both <em>R</em> and <em>L</em> also depend on Womersley number. To incorporate the storage capacity of the vessel in the model, a capacitor <em>C</em> is added to each side of the vascular segment, representing half of the total vascular compliance over that segment. The leakage <em>R<sub>L</sub></em> is captured by adding linear resistances (representing resistance to flow through small side-branches) in parallel to the capacitors. In addition, extravascular pressures <em>P<sub>e</sub></em> are prescribed as a <a href="#boundary_conditions">boundary condition parameter.</a></p>
</div>

<h4>Resistance element</h4>
<div class="description_2">
<div class="attachment_container">
	<a href="media/r_el.png" rel="lightbox" title="Resistance element"><img class="snippet" width="150" src="media/r_el.png" alt="Resistance element"/></a>
</div>
<p>This element is a very simple 0D model realized with a resistance, which can be linear or not, between two nodes.</p>
<p>Resistor <em>R</em> can be implemented as a variable resistance and its law will be described in the vascular network xml file according to the <a href="#regex">regular expression</a> structure for pyNS. User can decide to mesh each edge with this model simply assigning to the edge's <em>type</em> attribute the value <em>"Resistance"</em>.</p>
</div>

<h4>Anastomosis element</h4>
<div class="description_2">
<div class="attachment_container">
	<a href="media/an_el.png" rel="lightbox" title="Anastomosis element"><img class="snippet" width="150" src="media/an_el.png" alt="Anastomosis element"/></a>
</div>
<p>This element is a 0D model realized with 2 resistor between 3 nodes.</p>
<p>Anastomosis cannot be modeled by linear segments because the radial velocity component is no longer infinitesimally small compared to the axial velocity and flow separation can occur in this region. The velocity profile can thus not be based on fully developed flow in straight vessels. Consequently, a special element named Anastomosis, used as connection between an artery and a vein, is created to model the pressure losses over it.</p>
<p>In order to evaluate the non-linear resistance associated to each anastomosis configuration, the pressure drop across the computational domain must be accurately evaluated by means of CFD computations. We model blood as a Newtonian fluid with constant properties so that the flow across the anastomosis is approximated numerically solving the incompressible Navier-Stokes equations. The simulations are performed with <a href="https://github.com/lorbot/Gnuid" target="_blank">the opensource hemodynamics solver Gnuid</a> while <a href="http://www.vmtk.org/vmtk" target="_blank">vmtk</a> has been used for the generation of the vessels surfaces defining the anastomosis model.</p>
<div class="attachment_container">
	<a href="media/3dmesh.png" rel="lightbox" title="Hybrid mesh of the parameterized anastomosis obtained with vmtk"><img class="screenshot" width="150" src="media/3dmesh.png" alt="Hybrid mesh of the parameterized anastomosis obtained with vmtk"/></a>
</div>
<p>The Gnuid solver is based on a fully implicit implementation of the well known Pressure-Correction scheme introduced by Guermond and Quartapelle (<em>Guermond JL et al., On stability and convergence of projection methods based on pressure poisson equation. Int. J. Num. Meth. Fluids, 26:1039-1053 (1998).</em>) and used a discontinuous approximation for the velocity unknown and a continuous approximation for the pressure. The ability to combine a discontinuous Galerkin (dG) and a continuous Galerkin (cG) discretization in a dG-cG velocity-pressure space couple provides some interesting properties. It yields inherently inf-sup stable equal-order velocity-pressure discretizations, the better behaviour of discontinuous approximations in convection-dominated regimes is exploited in the advection-diffusion step and the cG formulation limits the cost of the Laplacian operator associated to the projection step.</p>
<div class="attachment_container">
	<a href="media/3dsim.png" rel="lightbox" title="CFD results on end-to-side anastomoses models"><img class="screenshot" width="150" src="media/3dsim.png" alt="CFD results on end-to-side anastomoses models"/></a>
</div>
<p>To ensure stability at high-Reynolds numbers and reduce the amount of artificial diffusion, the convective term is discretized following Di Pietro and Ern (<em>D. A. Di Pietro et al., Discrete functional analysis tools for discontinuous Galerkin methods with application to the incompressible Navier-Stokes equations. Math. Comp. 79, 1303-1330 (2010).</em>), where a non-dissipative formulation has been proposed.</p>
<div class="attachment_container">
	<a href="media/Pdrop.png" rel="lightbox" title="Pressure drop equation for anastomosis element"><img class="left_snippet" width="150" src="media/Pdrop.png" alt="Pressure drop equation for anastomosis element"/></a>
</div>
<p>The discretization has been validated against a large set of classical two- and three-dimensional tests covering a wide range of Reynolds numbers and has proved effective for the simulation of convection-dominated flows both from the accuracy and the computational cost viewpoints (<em>L. Botti et al., A pressure-correction scheme for convection-dominated incompressible flows with discontinuous velocity and continuous pressure. J. Comput. Phys., 230 (2011).</em>).</p>
</div>

<h4>Windkessel element</h4>
<div class="description_2">
<div class="attachment_container">
	<a href="media/wk_el.png" rel="lightbox" title="Windkessel element"><img class="snippet" src="media/wk_el.png" alt="Windkessel element"/></a>
</div>
<p>This element has been implemented with a 0D three-element Windkessel model, as illustrated in <em>Westerhof N. et al., An artificial arterial system for pumping hearts, J. Appl Phys 1971.</em>, consisting of a characteristic impedance, <em>Z<sub>wk</sub></em>, a resistance, <em>R<sub>wk</sub></em> and a compliance, <em>C<sub>wk</sub></em>. The characteristic impedance is chosen such that the reflections from high frequencies are attenuated. Standard reference pressure <em>P<sub>v</sub></em> and extravascular pressure <em>P<sub>e</sub></em> are prescribed as <a href="#boundary_conditions">boundary condition parameters.</a> Total resistance <em>R<sub>p</sub></em> (<em>Z<sub>wk</sub>+R<sub>wk</sub></em>) is defined as <em>P/(k*Q)</em> with <em>k</em> the fraction of the cardiac output flowing though the peripheral bed, <em>p</em> the mean arterial pressure and <em>q</em> the cardiac output. The pressure wave decreases during diastole with a time constant, that is equal to <em>R<sub>wk</sub>*C<sub>wk</sub></em>, which can be obtained from the descending slope of the local pressure curve during diastole or can be estimated based on literature.</p>
</div> 

<h3><a name="mesh_generation">Mesh generation</a></h3>
<div class="description_2">
<p>The mesh generation process is handled by Mesh Generator class which provides two different type of meshing strategies. The first method, called maxLenghtMeshing, creates meshes from edges taking into account the maximum length parameter decided by the user. Default value is 5 cm. If edge's length is greater than the maximum length parameter, mesh generator creates a number of meshes, each of them with the same length, corresponding to the integer value of the ratio between edge's length and maximum length parameter.</p>
<p>The second method, called toleranceMeshing, creates meshes from edges taking into account the radius tolerance parameter decided by the user. Default value is 33%. If edge's radius along the curvilinear abscissa increases more than tolerance, a new mesh is created.</p>
<p>During mesh generation process pyNS creates entities from superedges and builds the corresponding network Mesh object from its network Graph. This class can write vascular network mesh in a specific xml file which can be <a href="#load_mesh">imported into archNE.</a></p>
</div> 

<h3><a name="dofmap">From a local to a global environment</a></h3>
<div class="description_2">
<div class="attachment_container">
	<a href="media/dofmap.png" rel="lightbox" title="From a local to a global environment"><img class="screenshot" width="150" src="media/dofmap.png" alt="From a local to a global environment"/></a>
</div>
<p>Each element of the network knows only its nodes and its internal local degrees of freedom. A class, named dofmap, maps each local degree of freedom into a global degree of freedom,  handling connectivity between elements of the network.</p> 
<p>Dofmap is used by <a href="#assembler">Assembler class</a> to assembling global matrix from element's local matrices.</p>
</div>

<h3><a name="numerical_solver">The numerical solver</a></h3>
<div class="description_2">
<div class="attachment_container">
  <a href="media/numerical_scheme.png" rel="lightbox" title="Numerical scheme"><img class="snippet" src="media/numerical_scheme.png" alt="Numerical scheme"/></a>
</div>
<p>Solver class provides methods for solving the set of differential equations obtained by applying an analogue of Kirchoff's current law to satisfy element-to-element mass conservation.</p>
<p>The time derivative and time integral in the set of the differential equations are approximated by using an implicit trapezium rule with initial conditions (q<sub>0</sub>=0 and p<sub>0</sub>=0). The final scheme is shown in the figure.</p> 
<p>To solve, an iterative procedure is used. User can set timestep value and the total number of simulation cycles into <a href="#parameters">simulation parameters file.</a></p>
</div>

<h4><a name="assembler">Assembler class</a></h4>
<div class="description_2">
<p>Assembler class, using local to global map of degrees of freedom provided by dofmap class, builds three global matrices (zero, first and second order) joining into one square matrix of order corresponding to the number of global degrees of freedom all local matrices of the same type. Moreover assembler class stores a copy of linear global matrices built excluding local matrices of non linear elements, for improving performances during non linear simulations. This architecture permits to avoid the complete reassembling of global matrices in case of non linearities and to stay focused only on a section of global matrices corresponding to the non linearity.
</div>

<h4><a name="non_linear_convergence">Non-linear convergence strategy</a></h4>
<div class="description_2">
<p>A non-linear convergence strategy has been implemented for solving system with non-linear characteristics.</p>
<p>Solver class introduces an inertia relax coefficient (0.9) for improving convergence performances. Solution is thus considered as the sum between the 90% of the current solution <em>(p)</em> and the 10% of the solution at the previous non-linear incremental step <em>(p<sub>i</sub>)</em>. If non linear error, described as the ratio between the infinite norm of <em>p-p<sub>i</sub></em> and the infinite norm of p<sub>i</sub>, is larger than a predefined convergence tolerance <em>nltol</em>, the next non-linear incremental step is executed. Before executing the next non-linear incremental step pyNS has to evaluate non-linear elements and updating the system matrix.</p>
</div>


<h3><a name="post_processing">Post processing features</a></h3>
<div class="description_2">
</div>

<h4><a name="post_processing_plots">Graphical plots</a></h4>
<div class="description_2">
</div>

<h4><a name="post_processing_txt">Writing results in a text file</a></h4>
<div class="description_2">
</div>

<h4><a name="inverse_womersley">The inverse womersley method for computing wall shear stress</a></h4>
<div class="description_2">
</div>

<h2><a name="pyNS_how-to">pyNS how-to</a></h2>

<h2><a name="pyNS_examples">pyNS examples</a></h2>

<h2><a name="regex">Regular expression for xml equations</a></h2>

<h2><a name="archNE_documentation">archNE documentation</a></h2>


<div class="pre_footer"></div>